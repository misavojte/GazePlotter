var L=Object.defineProperty;var C=(f,m,g)=>m in f?L(f,m,{enumerable:!0,configurable:!0,writable:!0,value:g}):f[m]=g;var n=(f,m,g)=>(C(f,typeof m!="symbol"?m+"":m,g),g);(function(){"use strict";class f{constructor(){n(this,"data",{isOrdinalOnly:!1,stimuli:{data:[],orderVector:[]},participants:{data:[],orderVector:[]},categories:{data:[["Fixation"],["Saccade"]],orderVector:[]},aois:{data:[],orderVector:[],dynamicVisibility:{}},segments:[]})}add(e){var o,c;const t=this.processStimulus(e.stimulus),s=this.processParticipant(e.participant,t),i=this.processAOIs(e.aoi,t),r=this.processCategory(e.category);let a=[Number(e.start),Number(e.end),r];i!==null&&(a=a.concat(i)),(c=(o=this.data.segments[t])[s])!=null||(o[s]=[]),this.data.segments[t][s].push(a)}processStimulus(e){const t=this.data.stimuli.data;let s=t.findIndex(i=>i[0]===e);return s===-1&&(s=t.length,t.push([e]),this.data.aois.data.push([]),this.data.segments.push([])),s}processParticipant(e,t){const s=this.data.participants.data;let i=s.findIndex(r=>r[0]===e);return i===-1&&(i=s.length,s.push([e]),this.data.segments[t].push([])),i}processCategory(e){const t=this.data.categories.data;let s=t.findIndex(i=>i[0]===e);return s===-1&&(s=t.length,t.push([e])),s}processAOIs(e,t){if(e===null)return null;const s=[];for(let i=0;i<e.length;i++){const r=this.processAOI(e[i],t);r!==null&&s.push(r)}return s.length===0?null:s}processAOI(e,t){if(e===null)return null;const s=this.data.aois.data[t];let i=s.findIndex(r=>r[0]===e);return i===-1&&(i=s.length,s.push([e+""])),i}}class m{getIndex(e,t){const s=e.indexOf(t);if(s===-1)throw new Error(`Column ${t} not found in header`);return s}}class g extends m{constructor(t){super();n(this,"cStart");n(this,"cEnd");n(this,"cStimulus");n(this,"cParticipant");n(this,"cCategory");n(this,"cAoi");this.cStart=this.getIndex(t,"Event Start Trial Time [ms]"),this.cEnd=this.getIndex(t,"Event End Trial Time [ms]"),this.cStimulus=this.getIndex(t,"Stimulus"),this.cParticipant=this.getIndex(t,"Participant"),this.cCategory=this.getIndex(t,"Category"),this.cAoi=this.getIndex(t,"AOI Name")}reduce(t){const s=t[this.cStart],i=t[this.cEnd],r=t[this.cStimulus],a=t[this.cParticipant],o=t[this.cCategory],c=t[this.cAoi];return this.isNan(s)||this.isNan(i)||this.isInvalidCategory(o)?null:{aoi:this.transformAoi(c),category:o,end:i,participant:a,start:s,stimulus:r}}finalize(){return null}isNan(t){return isNaN(Number(t))}isInvalidCategory(t){return t==="Separator"}transformAoi(t){return t==="-"||t==="White Space"||t===null?null:[t]}}class A extends m{constructor(t,s=!1){super();n(this,"cAoiInfo");n(this,"cTime");n(this,"cStimulus");n(this,"cParticipant");n(this,"cRecording");n(this,"cCategory");n(this,"cEvent");n(this,"mIsOpen",!1);n(this,"mLastStimulus","");n(this,"mLastParticipant","");n(this,"mLastStartTime",0);n(this,"mLastSavedTime",0);n(this,"mBaseTime",0);n(this,"mLastCategory","");n(this,"mLastAoi",null);n(this,"mLastAoiString","");n(this,"TIME_MODIFIER",.001);n(this,"EVENT_START_STIMULUS","IntervalStart");n(this,"stimulusGetter");this.cTime=t.indexOf("Recording timestamp"),this.cStimulus=t.indexOf("Presented Stimulus name"),this.cParticipant=t.indexOf("Participant name"),this.cRecording=t.indexOf("Recording name"),this.cCategory=t.indexOf("Eye movement type"),this.cEvent=t.indexOf("Event"),this.cAoiInfo=this.createAoiInfo(t,this.createStimuliDictionary(t)),this.stimulusGetter=s?this.intervalStimulusGetter:this.baseStimulusGetter}createStimuliDictionary(t){const s=t.filter(i=>i.startsWith("AOI hit ["));return[...new Set(s.map(i=>i.replace(/AOI hit \[|\s-.*?]/g,"")).sort())]}createAoiInfo(t,s){const i=[];for(const r of s){const a=t.filter(c=>c.startsWith("AOI hit ["+r)),o=t.indexOf(a[0]);a.forEach((c,p)=>{const h=o+p,l=c.replace(/A.*?- |]/g,"");i.push({columnPosition:h,aoiName:l,stimulusName:r})})}return i}setLastValues(t,s,i,r,a){this.mLastStimulus=t,this.mLastParticipant=s,this.mLastStartTime=i-this.mBaseTime,this.mLastCategory=r,this.mLastAoi=a,this.mLastAoiString=a===null?"":a.join(";"),this.mIsOpen=!0}reduce(t){let s=null;const i=this.stimulusGetter(t);if(i==="")return null;const r=Number(t[this.cTime]);if(r===0)return null;const a=t[this.cParticipant]+"_"+t[this.cRecording],o=t[this.cCategory],c=this.getAoisFromRow(t);return i!==this.mLastStimulus||a!==this.mLastParticipant?(s=this.getReduceDataFromMemory(),this.mBaseTime=Number(t[this.cTime]),this.setLastValues(i,a,r,o,c)):(this.isAoiDifferent(c)||o!==this.mLastCategory)&&(s=this.getReduceDataFromMemory(),this.setLastValues(i,a,r,o,c)),this.mLastSavedTime=r-this.mBaseTime,s}finalize(){return this.getReduceDataFromMemory()}getReduceDataFromMemory(){return this.mIsOpen?{start:(this.mLastStartTime*this.TIME_MODIFIER).toString(),end:(this.mLastSavedTime*this.TIME_MODIFIER).toString(),stimulus:this.mLastStimulus,participant:this.mLastParticipant,category:this.mLastCategory,aoi:this.mLastAoi}:null}getAoisFromRow(t){const s=[];for(const i of this.cAoiInfo)t[i.columnPosition]==="1"&&s.push(i.aoiName);return s}isAoiDifferent(t){return this.mLastAoiString!==(t===null?"":t.join(";"))}baseStimulusGetter(t){return t[this.cStimulus]}intervalStimulusGetter(t){const s=t[this.cEvent];let i=this.mLastStimulus;return s.includes(this.EVENT_START_STIMULUS)&&(i=s.replace(" "+this.EVENT_START_STIMULUS,"")),i}}class S{orderAoisAlphabetically(e){const t=e.aois;for(let s=0;s<t.data.length;s++){const r=t.data[s].map((o,c)=>({index:c,name:o[0]}));r.sort((o,c)=>o.name.localeCompare(c.name));const a=r.map(o=>o.index);t.orderVector[s]=a}}orderParticipantsAlphabetically(e){const t=e.participants,s=t.data.map((r,a)=>({index:a,name:r[0]}));s.sort((r,a)=>r.name.localeCompare(a.name));const i=s.map(r=>r.index);t.orderVector=i}}class P extends S{process(e){return e=this.mergeDuplicatedSegments(this.sortSegments(e)),this.orderAoisAlphabetically(e),console.log(e),e}sortSegments(e){const t=e.segments.length,s=e.participants.data.length;for(let r=0;r<t;r++)for(let a=0;a<s;a++){const o=e.segments[r][a];o!==void 0&&o.sort(i)}function i(r,a){return r[0]-a[0]}return e}mergeDuplicatedSegments(e){const t=e.segments.length,s=e.participants.data.length,i=0;for(let r=0;r<t;r++)for(let a=0;a<s;a++){const o=e.segments[r][a];if(o!==void 0){let c=null,p=null,h=null;for(let l=0;l<o.length;l++){const d=o[l];d[0]===c&&d[1]===p&&d[2]===i&&h!==null?(o[h].slice(3).includes(d[3])||o[h].push(d[3]),o.splice(l,1),l--):h=l,c=d[0],p=d[1]}}}return e}}class D extends S{process(e){return this.orderAoisAlphabetically(e),e}}class E extends m{constructor(t,s){super();n(this,"cStart");n(this,"cTime");n(this,"cDurationOfFixation");n(this,"cDurationOfBlink");n(this,"cAOI");n(this,"cStimulus");n(this,"cFixID");n(this,"mTime",null);n(this,"mStart",null);n(this,"mDurationOfEvent",null);n(this,"mDurationOfFixation",null);n(this,"mAOI",null);n(this,"mStimulus",null);n(this,"mCategory",null);n(this,"mFixID",null);n(this,"mHasFixationSegmentEnded",!1);n(this,"participant");this.cStart=t.indexOf("FPOGS"),this.cTime=t.indexOf("FPOGS")-1,this.cDurationOfFixation=t.indexOf("FPOGD"),this.cDurationOfBlink=t.indexOf("BKDUR"),this.cAOI=t.indexOf("AOI"),this.cStimulus=t.indexOf("MEDIA_NAME"),this.cFixID=t.indexOf("FPOGID"),this.participant=s}reduce(t){let s=null;const i=t[this.cTime],r=t[this.cStart],a=t[this.cDurationOfFixation],o=t[this.cDurationOfBlink],c=t[this.cAOI]===""?null:t[this.cAOI],p=t[this.cStimulus],h=t[this.cFixID],l=o!=="0.00000",d=l?"Blink":"Fixation",T=Number(a)===this.mDurationOfEvent;return(this.mStimulus!==p||this.mFixID!==h||this.mCategory==="Blink"||T&&!this.mHasFixationSegmentEnded)&&(s=this.flush()),(this.mDurationOfFixation!==Number(a)||this.mStimulus!==p||this.mFixID!==h||l)&&(this.mStimulus=p,this.mAOI=c,this.mCategory=d,this.mDurationOfEvent=Number(l?o:a),this.mDurationOfFixation=Number(a),this.mTime=Number(i),this.mStart=l?Number(i)-this.mDurationOfEvent:Number(r),this.mFixID=h),this.mHasFixationSegmentEnded=T,s}finalize(){return this.flush()}flush(){if(this.mStimulus===null||this.mCategory===null||this.mStart===null||this.mDurationOfEvent===null)return null;let t={aoi:this.mAOI===null?null:[this.mAOI],category:this.mCategory,end:String(this.mTime),participant:this.participant,start:String(this.mStart),stimulus:this.mStimulus};return this.mStart===0&&this.mTime===0&&(console.warn("start and end are 0 - Probable blink issue",this.mFixID,this.mStimulus,this.participant),t=null),this.mTime=null,this.mStart=null,t}}class R extends S{process(e){return this.orderAoisAlphabetically(e),e}}class F extends m{constructor(t,s){super();n(this,"stimulusName");n(this,"cParticipant");n(this,"cSegments");this.stimulusName=s.split(".")[0].split("Similarity")[1],this.cParticipant=this.getIndex(t,"Sequence Similarity"),this.cSegments=this.getIndex(t,"Scanpath string")}finalize(){return null}reduce(t){const s=t[this.cSegments],i=t[this.cParticipant],r=[];for(let a=0;a<s.length;a++){const o=s[a]==="#"?null:[s[a]],c=a.toString(),p=(a+1).toString(),h="Fixation",l=this.stimulusName;r.push({aoi:o,category:h,end:p,participant:i,start:c,stimulus:l})}return r}}class w extends S{process(e){return this.orderAoisAlphabetically(e),e.isOrdinalOnly=!0,e}}class b{constructor(e){n(this,"lastRow","");n(this,"columnsIntegrity",0);n(this,"fileNames");n(this,"fileParsed",0);n(this,"columnDelimiter");n(this,"rowDelimiter");n(this,"type");n(this,"userInputSettings");n(this,"rowReducer",null);n(this,"rowStore",new f);n(this,"isPreviousFileProcessed",Promise.resolve());this.fileNames=e.fileNames,this.rowDelimiter=e.rowDelimiter,this.columnDelimiter=e.columnDelimiter,this.type=e.type,this.userInputSettings=e.userInputSetting}get filesToParse(){return this.fileNames.length}get currentFileName(){return this.fileNames[this.fileParsed]}async process(e){const t=e.pipeThrough(new TextDecoderStream).getReader(),s=async i=>await i.read().then(({value:r,done:a})=>{if(a){this.rowReducer!==null?(this.lastRow.length>0&&this.processRow(this.lastRow,this.rowReducer),this.processReduced(this.rowReducer.finalize())):console.warn("Empty file",this.currentFileName),this.lastRow="",this.rowReducer=null,this.fileParsed++;return}if(!!this.processPump(r))return s(i)});return await s(t),this.isPreviousFileProcessed=Promise.resolve(),this.filesToParse===this.fileParsed?this.getData():null}processPump(e){const t=(this.lastRow+e).split(this.rowDelimiter),s=t.length-1;let i=this.type==="ogama"?8:0;if(this.lastRow=t[t.length-1],t.length<2)return!0;if(this.rowReducer===null){const r=t[i].split(this.columnDelimiter);this.columnsIntegrity=r.length,this.rowReducer=this.getRowReducer(r),i++}for(let r=i;r<s;r++)this.processRow(t[r],this.rowReducer);return!0}getData(){const e=this.type,t=this.rowStore.data;if(e==="begaze")return new P().process(t);if(e==="tobii"||e==="tobii-with-event")return new D().process(t);if(e==="gazepoint")return new R().process(t);if(e==="ogama")return new w().process(t);throw new Error("File type for postprocessor not recognized")}getRowReducer(e){switch(this.type){case"begaze":return new g(e);case"tobii":return this.getTobiiReducer(e,!1);case"tobii-with-event":return this.getTobiiReducer(e,!0);case"gazepoint":{const t=this.currentFileName.split("_")[0];return new E(e,t)}case"ogama":return new F(e,this.currentFileName);default:throw new Error("File type row reducer not implemented")}}getTobiiReducer(e,t){const s=this.userInputSettings;if(t&&s===null)throw new Error("User input settings not set");const i=s==="event";return new A(e,i)}processRow(e,t){const s=e.split(this.columnDelimiter);if(s.length!==this.columnsIntegrity)throw new Error("Row integrity error");this.processReduced(t.reduce(s))}processReduced(e){if(Array.isArray(e)){e.forEach(t=>this.rowStore.add(t));return}e!==null&&this.rowStore.add(e)}}let y=null,I=[],x=0;self.onmessage=async u=>await v(u);async function v(u){const{data:e,type:t}=u.data;switch(t){case"settings":y=new b(e),x=e.fileNames.length;return;case"test-stream":return;case"stream":return await O(e);case"buffer":return await N(e);default:throw new Error("Unknown data type in worker",e)}}async function N(u){const e=new ReadableStream({start(t){t.enqueue(u),t.close()}});return await O(e)}async function O(u){if(y===null)throw new Error("Parser not initialized in worker");if(I.push(u),I.length===x)for(const e of I){const t=await y.process(e);t!==null&&(x=0,I=[],self.postMessage(t))}}})();
